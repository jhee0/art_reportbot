name: íƒœìŠ¤í¬ì›”ë“œ ì¼ì¼ ë™ê¸°í™”

# ì‹¤í–‰ íŠ¸ë¦¬ê±° ì„¤ì •
on:
  # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ ì‹¤í–‰ (UTC 22:00)
  schedule:
    - cron: '0 22 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰'
        required: false
        default: 'false'
        type: boolean

# ì‘ì—… ì •ì˜
jobs:
  sync-taskworld-data:
    name: íƒœìŠ¤í¬ì›”ë“œ ë°ì´í„° ë™ê¸°í™”
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
    
    # 2. Python í™˜ê²½ ì„¤ì •
    - name: ğŸ Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # 3. í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
    - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸
      run: |
        echo "í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì¤‘..."
        if [ -z "${{ secrets.TASKWORLD_EMAIL }}" ]; then
          echo "âŒ TASKWORLD_EMAILì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
        if [ -z "${{ secrets.TASKWORLD_PASSWORD }}" ]; then
          echo "âŒ TASKWORLD_PASSWORDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
        if [ -z "${{ secrets.PERSONAL_ACCESS_TOKEN }}" ]; then
          echo "âŒ PERSONAL_ACCESS_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
        echo "âœ… ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
    
    # 4. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“š í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 5. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: ğŸš€ íƒœìŠ¤í¬ì›”ë“œ ë°ì´í„° ë™ê¸°í™” ì‹¤í–‰
      env:
        TASKWORLD_EMAIL: ${{ secrets.TASKWORLD_EMAIL }}
        TASKWORLD_PASSWORD: ${{ secrets.TASKWORLD_PASSWORD }}
        TASKWORLD_WORKSPACE_NAME: ${{ secrets.TASKWORLD_WORKSPACE_NAME }}
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
      run: |
        echo "ğŸ• ì‹¤í–‰ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        python main.py
        echo "ğŸ‰ ì‹¤í–‰ ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S UTC')"
    
    # 6. ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC') (UTC)"
        echo "ğŸ•’ í•œêµ­ ì‹œê°„: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… ìƒíƒœ: ì„±ê³µ"
          echo "ğŸ¯ ê²°ê³¼: íƒœìŠ¤í¬ì›”ë“œ ë°ì´í„°ê°€ GitHub ì €ì¥ì†Œì— CSV íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ğŸ“ ìœ„ì¹˜: https://github.com/${{ github.repository }}/tree/main/data"
        else
          echo "âŒ ìƒíƒœ: ì‹¤íŒ¨"
          echo "ğŸ”§ ì¡°ì¹˜: Actions íƒ­ì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
        fi
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ì›Œí¬í”Œë¡œìš° ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  actions: read
